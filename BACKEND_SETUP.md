# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend –¥–ª—è AI CRM Analytics

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π backend-—Å–µ—Ä–≤–∏—Å –≤ –ø–∞–ø–∫–µ `backend/` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
- ‚úÖ Express —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8080
- ‚úÖ Prisma + PostgreSQL –¥–ª—è –ë–î
- ‚úÖ REST API —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `/api`
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è `http://localhost:3000`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ Bitrix24 (cron)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: Bitrix24, Telegram, OpenAI
- ‚úÖ Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ (–∑–∞–≥–ª—É—à–∫–∞)

### API Endpoints:
- ‚úÖ `GET /api/calls` - —Å–ø–∏—Å–æ–∫ –∑–≤–æ–Ω–∫–æ–≤
- ‚úÖ `GET /api/calls/:id` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- ‚úÖ `POST /api/calls/:id/process` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤–æ–Ω–∫–∞
- ‚úÖ `POST /api/calls/sync` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ Bitrix
- ‚úÖ `GET /api/analytics/employees` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- ‚úÖ `GET /api/analytics/trends` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–¥–æ–≤
- ‚úÖ `GET /api/chats` - —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)
- ‚úÖ `GET /api/reports` - —Å–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤
- ‚úÖ `POST /api/reports/test-telegram` - —Ç–µ—Å—Ç Telegram
- ‚úÖ `GET /api/settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ `POST /api/settings` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ `POST /api/webhooks/incoming/:token` - –≤—Ö–æ–¥—è—â–∏–µ webhooks
- ‚úÖ `GET /api/health` - healthcheck

### –°–µ—Ä–≤–∏—Å—ã:
- ‚úÖ `BitrixService` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Bitrix24
- ‚úÖ `CallService` - –∫–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤–æ–Ω–∫–æ–≤
- ‚úÖ `TranscriptionService` - —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —á–µ—Ä–µ–∑ Python
- ‚úÖ `AnalysisService` - –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ OpenAI GPT-4o
- ‚úÖ `TelegramService` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram
- ‚úÖ `SettingsService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
cd backend
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PostgreSQL:
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
createdb crm_analytics
```

### 3. –°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª:
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```

### 4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Prisma:
```bash
npx prisma generate
npx prisma migrate dev --name init
```

### 5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
npm run dev
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8080`

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   - –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env`
   - –ù–ï —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ –≤ –∫–æ–¥–µ
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω

2. **Python —Å–∫—Ä–∏–ø—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏:**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞
   - –ó–∞–º–µ–Ω–∏—Ç–µ `python/transcribe_and_return.py` –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
   - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Whisper, Google Speech-to-Text –∏ —Ç.–¥.

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `BITRIX_SYNC_INTERVAL_MINUTES`)
   - –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ `POST /api/calls/sync`

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º:**
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `http://localhost:8080/api`
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–±–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### Bitrix24:
1. –°–æ–∑–¥–∞–π—Ç–µ –≤—Ö–æ–¥—è—â–∏–π webhook –≤ Bitrix24
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –≤ `BITRIX_WEBHOOK_URL`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞:
   - `crm.activity.list`
   - `crm.activity.get`
   - `voximplant.statistic.get` –∏–ª–∏ `telephony.call.list`

### Telegram:
1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ `TELEGRAM_BOT_TOKEN`
3. –ü–æ–ª—É—á–∏—Ç–µ chat ID (–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ @userinfobot)
4. –í—Å—Ç–∞–≤—å—Ç–µ –≤ `TELEGRAM_CHAT_ID`

### OpenAI:
1. –°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ https://platform.openai.com
2. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ `OPENAI_API_KEY`
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `backend/INSTALLATION.md`
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: `backend/QUICK_START.md`
- README: `backend/README.md`

## ‚ö†Ô∏è Troubleshooting

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `.env`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞

### –û—à–∏–±–∫–∞ Prisma:
```bash
npx prisma generate
npx prisma migrate reset
npx prisma migrate dev
```

### –ü–æ—Ä—Ç –∑–∞–Ω—è—Ç:
- –ò–∑–º–µ–Ω–∏—Ç–µ `PORT` –≤ `.env`
- –ò–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 8080

### Python –Ω–µ –Ω–∞–π–¥–µ–Ω:
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3.8+
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `PYTHON_PATH` –≤ `.env`
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ `python3` –≤–º–µ—Å—Ç–æ `python`

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ó–∞–º–µ–Ω–∏—Ç–µ –∑–∞–≥–ª—É—à–∫—É —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤—Å–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (Bitrix, Telegram, OpenAI)
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏–∑ Bitrix24
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ OpenAI
5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –≤ Telegram

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ `backend/README.md`

