# üéØ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω–≤–µ–π–µ—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–≤–æ–Ω–∫–æ–≤

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. Backend - –ü–æ–ª–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏

#### CallService.processCall()
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ)
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `in_progress` –≤ –Ω–∞—á–∞–ª–µ
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ `recordUrl` –∏–∑ Bitrix (–µ—Å–ª–∏ –Ω–µ—Ç)
- ‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ ‚Üí —Å—Ç–∞—Ç—É—Å `audio_downloaded`
- ‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è —á–µ—Ä–µ–∑ faster-whisper ‚Üí —Å—Ç–∞—Ç—É—Å `transcribed`
- ‚úÖ –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ OpenAI ‚Üí —Å—Ç–∞—Ç—É—Å `analyzed`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: `transcriptText`, `analysisJson`, `scoreOverall`, `riskLevel`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ `error`

#### CallService.processPendingCalls()
- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ pending –∑–≤–æ–Ω–∫–∏ (status: `new`, `in_progress` –∏–ª–∏ –±–µ–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ 50 –∑–≤–æ–Ω–∫–æ–≤ –∑–∞ —Ä–∞–∑
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `{ processed, errors }`

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (`POST /api/calls/sync`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
- ‚úÖ Cron-–∑–∞–¥–∞—á–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pending –∑–≤–æ–Ω–∫–∏
- ‚úÖ Cron-–∑–∞–¥–∞—á–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤

#### API Endpoints
- ‚úÖ `POST /api/calls/sync` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
- ‚úÖ `POST /api/calls/process-pending` - —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö pending –∑–≤–æ–Ω–∫–æ–≤
- ‚úÖ `POST /api/calls/:id/process` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
- ‚úÖ `GET /api/calls/:id` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º `analysis` (–Ω–µ `analysisJson`)

#### BitrixService
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ `recordUrl` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
- ‚úÖ –ú–µ—Ç–æ–¥ `getCallInfo` —Ç–µ–ø–µ—Ä—å –ø—É–±–ª–∏—á–Ω—ã–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ CallService
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å `recordUrl` —á–µ—Ä–µ–∑ `bitrixCallId` –∏ `bitrixActivityId`

### 2. Frontend - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### –¢–∞–±–ª–∏—Ü–∞ –∑–≤–æ–Ω–∫–æ–≤ (Calls.tsx)
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç `scoreOverall` –∏ `riskLevel` –∏–∑ –ë–î
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã: `new`, `in_progress`, `audio_downloaded`, `transcribed`, `analyzed`, `error`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∏—Å–∫–æ–≤ (low/medium/high)
- ‚úÖ –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

#### CallDetails.tsx
- ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API —Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–º `analysis`
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ —Å–µ–∫—Ü–∏—è–º —Å –æ—Ü–µ–Ω–∫–∞–º–∏
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å" –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π: loading, error, –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–Ω–≤–µ–π–µ—Ä

### –®–∞–≥ 1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```powershell
POST /api/calls/sync
```
1. –ü–æ–ª—É—á–∞–µ—Ç –∑–≤–æ–Ω–∫–∏ –∏–∑ Bitrix —á–µ—Ä–µ–∑ `BitrixService.getRecentCalls()`
2. –°–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `new`
3. –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å `recordUrl` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ** (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç)

### –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ (processCall)
```
new ‚Üí in_progress ‚Üí audio_downloaded ‚Üí transcribed ‚Üí analyzed
```

1. **in_progress**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ recordUrl**: –ï—Å–ª–∏ –Ω–µ—Ç, –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ Bitrix API
3. **audio_downloaded**: –°–∫–∞—á–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ –≤ `data/calls/call_<id>.mp3`
4. **transcribed**: –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ faster-whisper, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `transcriptText`
5. **analyzed**: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ OpenAI, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç:
   - `analysisJson` (JSON —Å—Ç—Ä–æ–∫–∞)
   - `scoreOverall` (0-100)
   - `riskLevel` (low/medium/high)
   - –°—Ç–∞—Ç—É—Å `analyzed`

### –®–∞–≥ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- **–ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ
- **Cron –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pending –∑–≤–æ–Ω–∫–∏
- **Cron —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**: –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### Call –≤ –ë–î (Prisma Schema)
```prisma
model Call {
  id              Int      @id @default(autoincrement())
  bitrixActivityId Int?
  bitrixCallId    String?
  recordUrl       String?      // URL –∑–∞–ø–∏—Å–∏ –∏–∑ Bitrix
  localAudioPath  String?      // –ü—É—Ç—å –∫ —Å–∫–∞—á–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
  transcriptText  String?      // –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
  analysisJson    String?      // JSON —Å—Ç—Ä–æ–∫–∞ —Å –∞–Ω–∞–ª–∏–∑–æ–º
  scoreOverall    Int?         // 0-100
  riskLevel       String?       // low/medium/high
  status          String        // new/in_progress/audio_downloaded/transcribed/analyzed/error
  ...
}
```

### Analysis JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```json
{
  "scores": {
    "greeting": 1-5,
    "needs": 1-5,
    "presentation": 1-5,
    "objections": 1-5,
    "closing": 1-5,
    "tone": 1-5,
    "overall": 0-100
  },
  "sections": {
    "greeting": {
      "how_it_was": "...",
      "how_to_improve": "..."
    },
    ...
  },
  "sentiment": {
    "client": "positive|neutral|negative",
    "manager": "positive|neutral|negative",
    "overall": -1 to 1
  },
  "conflict": {
    "level": "low|medium|high",
    "detected": true/false,
    "reasons": [...]
  },
  "recommendations": [...],
  "alternative_phrases": [...],
  "script_improvements": [...],
  "summary": "..."
}
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É)
```powershell
Invoke-WebRequest -Uri http://localhost:8080/api/calls/sync -Method POST
```

### 2. –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö pending –∑–≤–æ–Ω–∫–æ–≤
```powershell
Invoke-WebRequest -Uri http://localhost:8080/api/calls/process-pending -Method POST
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
```powershell
Invoke-WebRequest -Uri http://localhost:8080/api/calls/1/process -Method POST
```

### 4. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ó–≤–æ–Ω–∫–∏"
- –ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å"
- –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–≤–æ–Ω–∫–∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- –û—Ç–∫—Ä–æ–π—Ç–µ –∑–≤–æ–Ω–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### Cron –∑–∞–¥–∞—á–∏ (backend/src/app.ts)
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –ö–∞–∂–¥—ã–µ `BITRIX_SYNC_INTERVAL_MINUTES` –º–∏–Ω—É—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ pending**: –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- `processPendingCalls` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 50 –∑–≤–æ–Ω–∫–æ–≤ –∑–∞ —Ä–∞–∑
- –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–≤–æ–Ω–∫–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º—É)

## ‚úÖ –ì–æ—Ç–æ–≤–æ!

–ö–æ–Ω–≤–µ–π–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è, –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ.

